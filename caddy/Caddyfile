{
    # Global options
    admin 0.0.0.0:2019
    metrics
    email admin@{$DOMAIN}
    # Uncomment for staging during testing to avoid rate limits:
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

{$DOMAIN} {
    # Prometheus remote write endpoint (with Basic Auth)
    handle /prometheus/* {
        basicauth {
            {$BASIC_AUTH_USER} {$BASIC_AUTH_PASSWORD_HASH}
        }
        uri strip_prefix /prometheus
        reverse_proxy prometheus:9090 {
            transport http {
                read_timeout 60s
                write_timeout 60s
            }
        }
    }

    # Loki push endpoint (with Basic Auth)
    handle /loki/* {
        basic_auth {
            {$BASIC_AUTH_USER} {$BASIC_AUTH_PASSWORD_HASH}
        }
        reverse_proxy loki:3100 {
            transport http {
                read_timeout 60s
                write_timeout 60s
            }
        }
    }

    # Default - Grafana UI
    handle {
        reverse_proxy grafana:3000
    }

    # Enable compression
    encode gzip

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}
