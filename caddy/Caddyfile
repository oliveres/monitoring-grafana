{
    # Global options
    email admin@{$DOMAIN}
    # Uncomment for staging during testing to avoid rate limits:
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main Grafana interface
{$DOMAIN} {
    # Automatic HTTPS via Let's Encrypt

    # Grafana reverse proxy
    reverse_proxy grafana:3000

    # Enable compression
    encode gzip

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Prometheus remote write endpoint (for remote VPS with Basic Auth)
{$DOMAIN}/prometheus/* {
    # Basic authentication for remote VPS
    basicauth {
        {$BASIC_AUTH_USER} {$BASIC_AUTH_PASSWORD_HASH}
    }

    # Strip /prometheus prefix and proxy to Prometheus
    uri strip_prefix /prometheus
    reverse_proxy prometheus:9090

    # Longer timeout for remote write
    @remotewrite path /api/v1/write
    handle @remotewrite {
        reverse_proxy prometheus:9090 {
            transport http {
                read_timeout 60s
                write_timeout 60s
            }
        }
    }
}

# Loki push endpoint (for remote VPS with Basic Auth)
{$DOMAIN}/loki/* {
    # Basic authentication for remote VPS
    basicauth {
        {$BASIC_AUTH_USER} {$BASIC_AUTH_PASSWORD_HASH}
    }

    # Strip /loki prefix and proxy to Loki
    uri strip_prefix /loki
    reverse_proxy loki:3100

    # Longer timeout for log pushes
    @push path /api/v1/push
    handle @push {
        reverse_proxy loki:3100 {
            transport http {
                read_timeout 60s
                write_timeout 60s
            }
        }
    }
}
